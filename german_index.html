<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>German Momentum Screener ‚Äî DAX ¬∑ MDAX ¬∑ SDAX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;0,600;1,300&family=IBM+Plex+Sans:wght@300;400;600&family=Syne:wght@700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg:       #080b0f;
      --surface:  #0c1117;
      --surface2: #101820;
      --border:   #1a2530;
      --border2:  #22303d;
      --text:     #c0d0e0;
      --muted:    #445565;
      --muted2:   #607080;
      --accent:   #f0a500;   /* German gold */
      --accent2:  #e03030;   /* German red */
      --accent3:  #1a1a1a;   /* German black */
      --blue:     #4499ff;
      --green:    #00cc88;
      --white:    #eef2f6;
      --gold:     #f0c040;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 300;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Scanline */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background: repeating-linear-gradient(
        0deg, transparent, transparent 2px,
        rgba(0,0,0,0.05) 2px, rgba(0,0,0,0.05) 4px
      );
      pointer-events: none; z-index: 9999;
    }

    /* Grid */
    body::after {
      content: '';
      position: fixed; inset: 0;
      background-image:
        linear-gradient(rgba(240,165,0,0.012) 1px, transparent 1px),
        linear-gradient(90deg, rgba(240,165,0,0.012) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none; z-index: 0;
    }

    /* Ambient glows ‚Äî German flag colours */
    .glow-tl {
      position: fixed; top: -100px; left: -100px;
      width: 420px; height: 420px;
      background: radial-gradient(circle, rgba(240,165,0,0.055) 0%, transparent 70%);
      pointer-events: none; z-index: 0;
    }
    .glow-br {
      position: fixed; bottom: -80px; right: -80px;
      width: 380px; height: 380px;
      background: radial-gradient(circle, rgba(224,48,48,0.04) 0%, transparent 70%);
      pointer-events: none; z-index: 0;
    }

    .container {
      position: relative; z-index: 1;
      max-width: 1140px;
      margin: 0 auto;
      padding: 0 28px 100px;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      padding: 52px 0 40px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 48px;
      animation: fadeDown 0.65s ease both;
    }

    .header-inner {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
    }

    .brand { display: flex; flex-direction: column; gap: 10px; }

    .brand-flag {
      display: flex;
      gap: 0;
      width: 36px;
      height: 6px;
      border-radius: 1px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .brand-flag span {
      flex: 1;
    }
    .brand-flag .f1 { background: #1a1a1a; }
    .brand-flag .f2 { background: #e03030; }
    .brand-flag .f3 { background: #f0a500; }

    .brand-tag {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.28em;
      color: var(--accent);
      text-transform: uppercase;
      background: rgba(240,165,0,0.07);
      border: 1px solid rgba(240,165,0,0.2);
      padding: 4px 12px;
      display: inline-block;
      width: fit-content;
    }

    h1 {
      font-family: 'IBM Plex Mono', monospace;
      font-size: clamp(24px, 4.5vw, 40px);
      font-weight: 600;
      color: var(--white);
      line-height: 1.05;
      letter-spacing: -0.03em;
    }
    h1 em { font-style: normal; color: var(--accent); }

    .brand-sub {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: 0.04em;
    }

    .header-right {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      text-align: right;
      line-height: 2;
    }

    .live-dot {
      display: inline-block;
      width: 7px; height: 7px;
      background: var(--green);
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2.2s ease infinite;
    }

    /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
    .stats-row {
      display: flex;
      gap: 14px;
      margin-bottom: 44px;
      flex-wrap: wrap;
      animation: fadeDown 0.65s 0.1s ease both;
    }

    .stat-card {
      flex: 1;
      min-width: 130px;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 16px 20px;
    }

    .stat-card .num {
      font-family: 'Syne', sans-serif;
      font-size: 26px;
      font-weight: 800;
      color: var(--white);
      letter-spacing: -0.02em;
    }

    .stat-card .num.gold { color: var(--accent); }

    .stat-card .lbl {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-top: 3px;
    }

    /* ‚îÄ‚îÄ TABLE SECTION ‚îÄ‚îÄ */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      animation: fadeDown 0.65s 0.15s ease both;
    }

    .section-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.22em;
      color: var(--accent);
      text-transform: uppercase;
    }

    .exchange-badge {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      background: var(--surface);
      border: 1px solid var(--border2);
      padding: 4px 10px;
      letter-spacing: 0.1em;
    }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .table-wrap {
      overflow-x: auto;
      animation: fadeUp 0.65s 0.2s ease both;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
    }

    thead tr { border-bottom: 1px solid var(--border2); }

    thead th {
      padding: 10px 14px;
      text-align: left;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.15em;
      color: var(--muted);
      text-transform: uppercase;
      white-space: nowrap;
    }
    thead th.right { text-align: right; }
    thead th.center { text-align: center; }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
      cursor: pointer;
      animation: rowIn 0.4s ease both;
    }
    tbody tr:hover { background: rgba(240,165,0,0.025); }

    /* staggered row animation */
    tbody tr:nth-child(1)  { animation-delay: 0.22s; }
    tbody tr:nth-child(2)  { animation-delay: 0.25s; }
    tbody tr:nth-child(3)  { animation-delay: 0.28s; }
    tbody tr:nth-child(4)  { animation-delay: 0.31s; }
    tbody tr:nth-child(5)  { animation-delay: 0.34s; }
    tbody tr:nth-child(6)  { animation-delay: 0.37s; }
    tbody tr:nth-child(7)  { animation-delay: 0.40s; }
    tbody tr:nth-child(8)  { animation-delay: 0.43s; }
    tbody tr:nth-child(9)  { animation-delay: 0.46s; }
    tbody tr:nth-child(10) { animation-delay: 0.49s; }
    tbody tr:nth-child(11) { animation-delay: 0.52s; }
    tbody tr:nth-child(12) { animation-delay: 0.55s; }
    tbody tr:nth-child(13) { animation-delay: 0.58s; }
    tbody tr:nth-child(14) { animation-delay: 0.61s; }
    tbody tr:nth-child(15) { animation-delay: 0.64s; }
    tbody tr:nth-child(16) { animation-delay: 0.67s; }
    tbody tr:nth-child(17) { animation-delay: 0.70s; }
    tbody tr:nth-child(18) { animation-delay: 0.73s; }
    tbody tr:nth-child(19) { animation-delay: 0.76s; }
    tbody tr:nth-child(20) { animation-delay: 0.79s; }

    tbody td {
      padding: 13px 14px;
      white-space: nowrap;
    }
    tbody td.right  { text-align: right; }
    tbody td.center { text-align: center; }

    /* Rank */
    .rank-num {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 800;
      color: var(--border2);
    }
    tr:nth-child(1) .rank-num { color: var(--accent); }
    tr:nth-child(2) .rank-num { color: rgba(240,165,0,0.55); }
    tr:nth-child(3) .rank-num { color: rgba(240,165,0,0.35); }

    /* Ticker / company */
    .ticker-main {
      font-weight: 500;
      color: var(--white);
      letter-spacing: 1px;
      display: block;
    }
    .company-name {
      font-size: 11px;
      color: var(--muted2);
      margin-top: 2px;
      display: block;
    }

    /* Index badge */
    .idx-badge {
      font-size: 9px;
      font-weight: 500;
      letter-spacing: 0.1em;
      padding: 2px 7px;
      border: 1px solid;
      border-radius: 1px;
    }
    .idx-dax   { color: var(--accent);  border-color: rgba(240,165,0,0.3);  background: rgba(240,165,0,0.06); }
    .idx-mdax  { color: var(--blue);    border-color: rgba(68,153,255,0.3); background: rgba(68,153,255,0.06); }
    .idx-sdax  { color: var(--muted2);  border-color: var(--border2);       background: rgba(255,255,255,0.03); }

    /* Score bar */
    .score-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-end;
    }
    .score-val {
      font-weight: 600;
      color: var(--accent);
      min-width: 44px;
      text-align: right;
    }
    .score-bar-bg {
      width: 56px; height: 4px;
      background: var(--border2);
      border-radius: 2px;
      overflow: hidden;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
    }

    /* Momentum cells */
    .mom-pos { color: var(--green); }
    .mom-neg { color: #ff5566; }
    .mom-neu { color: var(--muted2); }

    /* RSL */
    .rsl-ok  { color: var(--green); }
    .rsl-mid { color: var(--accent); }

    /* Rank change */
    .rank-change {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 7px;
      font-size: 11px;
      font-weight: 500;
      border-radius: 2px;
    }
    .rank-up   { color: var(--green);  background: rgba(0,204,136,0.08); }
    .rank-down { color: #ff5566;       background: rgba(255,85,102,0.08); }
    .rank-same { color: var(--muted);  background: rgba(255,255,255,0.04); }
    .rank-new  { color: var(--gold);   background: rgba(240,192,64,0.08); font-size: 10px; letter-spacing: 0.1em; }

    /* Mini sparkline canvas */
    .sparkline { display: block; }

    /* ‚îÄ‚îÄ HISTORY SECTION ‚îÄ‚îÄ */
    .history-section {
      margin-top: 72px;
      animation: fadeUp 0.65s 0.35s ease both;
    }

    .history-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.22em;
      color: var(--blue);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .history-sub {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 28px;
    }

    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .history-card {
      background: var(--surface);
      border: 1px solid var(--border2);
      padding: 20px 22px 16px;
      position: relative;
      overflow: hidden;
    }

    .history-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--accent);
      opacity: 0.4;
    }

    .hcard-ticker {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      font-weight: 600;
      color: var(--white);
      letter-spacing: 1px;
    }

    .hcard-name {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
      margin-bottom: 14px;
    }

    .hcard-chart {
      width: 100%;
      height: 52px;
      display: block;
    }

    .hcard-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--muted);
    }

    .hcard-weeks {
      color: var(--accent);
      font-weight: 500;
    }

    /* ‚îÄ‚îÄ STRATEGY BOX ‚îÄ‚îÄ */
    .strategy-box {
      margin-top: 64px;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-left: 3px solid var(--accent);
      padding: 32px 36px;
      animation: fadeUp 0.65s 0.45s ease both;
    }

    .strategy-box h2 {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.2em;
      color: var(--accent);
      text-transform: uppercase;
      margin-bottom: 20px;
    }

    .strategy-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 40px;
    }
    @media (max-width: 600px) { .strategy-grid { grid-template-columns: 1fr; } }

    .strat-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 5px;
    }
    .strat-val {
      font-size: 13px;
      color: var(--text);
      line-height: 1.6;
    }

    .formula-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .formula-pill {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      padding: 6px 14px;
      border: 1px solid;
    }
    .fp-12m { color: var(--accent);  border-color: rgba(240,165,0,0.3);  background: rgba(240,165,0,0.06); }
    .fp-6m  { color: var(--blue);    border-color: rgba(68,153,255,0.3); background: rgba(68,153,255,0.06); }
    .fp-3m  { color: var(--green);   border-color: rgba(0,204,136,0.3);  background: rgba(0,204,136,0.06); }
    .fp-rsl { color: #ff5566;        border-color: rgba(255,85,102,0.3); background: rgba(255,85,102,0.06); }

    /* ‚îÄ‚îÄ LOADER / ERROR ‚îÄ‚îÄ */
    .loader {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 280px;
      gap: 12px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      color: var(--muted);
    }
    .spinner {
      width: 18px; height: 18px;
      border: 2px solid var(--border2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .error-msg {
      display: none;
      padding: 20px;
      border: 1px solid rgba(255,85,102,0.3);
      color: #ff5566;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      background: rgba(255,85,102,0.05);
    }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer {
      margin-top: 72px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      animation: fadeDown 0.65s 0.55s ease both;
    }
    footer a { color: var(--muted); text-decoration: none; }
    footer a:hover { color: var(--accent); }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes rowIn {
      from { opacity: 0; transform: translateX(-8px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse {
      0%,100% { opacity:1; box-shadow: 0 0 0 0 rgba(0,204,136,0.5); }
      50%      { box-shadow: 0 0 0 5px rgba(0,204,136,0); }
    }

    /* No-history placeholder */
    .no-history {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      padding: 32px;
      border: 1px dashed var(--border2);
      text-align: center;
      line-height: 1.8;
    }
  </style>
</head>
<body>

<div class="glow-tl"></div>
<div class="glow-br"></div>

<div class="container">

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-flag">
          <span class="f1"></span>
          <span class="f2"></span>
          <span class="f3"></span>
        </div>
        <div class="brand-tag">Compound Momentum ¬∑ Germany</div>
        <h1>German <em>Momentum</em><br>Screener</h1>
        <div class="brand-sub">DAX ¬∑ MDAX ¬∑ SDAX ¬∑ Xetra ¬∑ EUR</div>
      </div>
      <div class="header-right">
        <div><span class="live-dot"></span><span id="updated-time">Loading‚Ä¶</span></div>
        <div id="stocks-screened">‚Äî stocks screened</div>
        <div>12m ¬∑ 6m ¬∑ 3m momentum composite</div>
        <div>RSL filter: above 130-day SMA</div>
        <div>Source: Yahoo Finance</div>
      </div>
    </div>
  </header>

  <!-- STATS -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="num gold" id="stat-screened">‚Äî</div>
      <div class="lbl">Stocks Screened</div>
    </div>
    <div class="stat-card">
      <div class="num" id="stat-above-rsl">‚Äî</div>
      <div class="lbl">Above RSL 1.0</div>
    </div>
    <div class="stat-card">
      <div class="num gold" id="stat-top-score">‚Äî</div>
      <div class="lbl">Top Score</div>
    </div>
    <div class="stat-card">
      <div class="num" id="stat-new-entries">‚Äî</div>
      <div class="lbl">New Entries</div>
    </div>
    <div class="stat-card">
      <div class="num" id="stat-weeks">‚Äî</div>
      <div class="lbl">Weeks of History</div>
    </div>
  </div>

  <!-- ERROR -->
  <div class="error-msg" id="error-msg">
    ‚ö† Could not load screener_data.json. Make sure the file exists and GitHub Pages is enabled.
  </div>

  <!-- TABLE -->
  <div class="section-header">
    <div class="section-title">Top 20 ¬∑ Compound Momentum Ranking</div>
    <div class="exchange-badge">Xetra ¬∑ EUR</div>
  </div>

  <div class="table-wrap" id="table-wrap">
    <div class="loader" id="loader">
      <div class="spinner"></div>
      Fetching latest data‚Ä¶
    </div>
    <table id="main-table" style="display:none">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Ticker / Company</th>
          <th class="center">Index</th>
          <th class="right">Score</th>
          <th class="right">12M Mom</th>
          <th class="right">6M Mom</th>
          <th class="right">3M Mom</th>
          <th class="right">RSL</th>
          <th class="right">Price (‚Ç¨)</th>
          <th class="center">vs Last Week</th>
          <th class="center">Trend</th>
        </tr>
      </thead>
      <tbody id="main-tbody"></tbody>
    </table>
  </div>

  <!-- HISTORY SECTION -->
  <div class="history-section" id="history-section" style="display:none">
    <div class="history-title">Rank History</div>
    <div class="history-sub" id="history-sub">Loading history‚Ä¶</div>
    <div class="history-grid" id="history-grid"></div>
  </div>

  <!-- STRATEGY BOX -->
  <div class="strategy-box">
    <h2>Strategy Overview</h2>
    <div class="strategy-grid">
      <div>
        <div class="strat-label">Universe</div>
        <div class="strat-val">DAX (40) + MDAX (60) + SDAX (70) ‚Äî ~170 German stocks listed on Xetra. Tickers auto-synced via pytickersymbols.</div>
      </div>
      <div>
        <div class="strat-label">Composite Formula</div>
        <div class="strat-val">40% √ó 12-month momentum rank + 35% √ó 6-month rank + 25% √ó 3-month rank. Skips most recent month per academic convention.</div>
      </div>
      <div>
        <div class="strat-label">RSL Filter</div>
        <div class="strat-val">Only stocks with RSL ‚â• 1.0 are eligible ‚Äî current price must be above its 130-day moving average. Avoids downtrending stocks.</div>
      </div>
      <div>
        <div class="strat-label">Rebalancing</div>
        <div class="strat-val">Updated every Friday after Xetra closes (~18:30 CET). Automated via GitHub Actions. History accumulates weekly.</div>
      </div>
    </div>
    <div class="formula-row">
      <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);align-self:center;letter-spacing:0.1em;text-transform:uppercase;">Weights</span>
      <span class="formula-pill fp-12m">12M ¬∑ 40%</span>
      <span class="formula-pill fp-6m">6M ¬∑ 35%</span>
      <span class="formula-pill fp-3m">3M ¬∑ 25%</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);align-self:center;margin-left:8px;letter-spacing:0.1em;text-transform:uppercase;">Filter</span>
      <span class="formula-pill fp-rsl">RSL ‚â• 1.0</span>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <span>‚ö† For informational purposes only ‚Äî not financial advice.</span>
    <span>
      <a href="https://alex30free.github.io/">‚Üê StockLab Home</a>
    </span>
  </footer>

</div>

<script>
// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function fmtEur(n) {
  if (n == null) return '‚Äî';
  return '‚Ç¨' + n.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtPct(n) {
  if (n == null) return '‚Äî';
  return (n >= 0 ? '+' : '') + n.toFixed(1) + '%';
}
function momClass(v) {
  return v > 0 ? 'mom-pos' : v < 0 ? 'mom-neg' : 'mom-neu';
}

// ‚îÄ‚îÄ Detect which index a .DE ticker belongs to (rough heuristic from name) ‚îÄ‚îÄ
// The screener_data.json doesn't store index membership, so we infer from
// a lookup built at runtime from history or just show blank.
// For a clean solution the screener.py could store index membership ‚Äî for now
// we leave badge empty and it won't break anything.
function indexBadge(ticker) {
  return '';  // placeholder ‚Äî populated if you add index field to screener output
}

// ‚îÄ‚îÄ Draw a tiny sparkline rank chart on a <canvas> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSparkline(canvas, ranks, maxWeeks) {
  const ctx  = canvas.getContext('2d');
  const W    = canvas.clientWidth || 236;
  const H    = canvas.clientHeight || 52;
  canvas.width  = W * window.devicePixelRatio;
  canvas.height = H * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  if (!ranks || ranks.length < 2) {
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    ctx.fillRect(0, H/2 - 1, W, 2);
    ctx.font = '10px IBM Plex Mono';
    ctx.fillStyle = '#445565';
    ctx.textAlign = 'center';
    ctx.fillText('Not enough history yet', W/2, H/2 + 4);
    return;
  }

  const minR  = 1;
  const maxR  = maxWeeks || 20;
  const pad   = 4;
  const pts   = ranks.map((r, i) => ({
    x: pad + (i / (ranks.length - 1)) * (W - pad * 2),
    // rank 1 = top of chart, rank 20 = bottom
    y: pad + ((r - minR) / (maxR - minR)) * (H - pad * 2)
  }));

  // Gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(240,165,0,0.18)');
  grad.addColorStop(1, 'rgba(240,165,0,0)');

  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  pts.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, H);
  ctx.lineTo(pts[0].x, H);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  pts.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = 'rgba(240,165,0,0.8)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Latest dot
  const last = pts[pts.length - 1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 3, 0, Math.PI * 2);
  ctx.fillStyle = '#f0a500';
  ctx.fill();
}

// ‚îÄ‚îÄ Draw inline sparkline in table (last 8 weeks) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawMiniSparkline(canvas, ranks) {
  const ctx = canvas.getContext('2d');
  const W = 60, H = 20;
  canvas.width  = W * window.devicePixelRatio;
  canvas.height = H * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  if (!ranks || ranks.length < 2) {
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(0, H/2); ctx.lineTo(W, H/2); ctx.stroke();
    return;
  }

  const minR = Math.min(...ranks);
  const maxR = Math.max(...ranks);
  const range = Math.max(maxR - minR, 1);
  const pts = ranks.map((r, i) => ({
    x: (i / (ranks.length - 1)) * W,
    y: 2 + ((r - minR) / range) * (H - 4)
  }));

  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  pts.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = 'rgba(240,165,0,0.7)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  const last = pts[pts.length - 1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 2, 0, Math.PI * 2);
  ctx.fillStyle = '#f0a500';
  ctx.fill();
}

// ‚îÄ‚îÄ Main data loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAll() {
  try {
    const [dataRes, histRes] = await Promise.all([
      fetch('screener_data.json?_=' + Date.now()),
      fetch('history.json?_=' + Date.now()).catch(() => null)
    ]);

    if (!dataRes.ok) throw new Error('screener_data.json not found');
    const data = await dataRes.json();

    let history = [];
    if (histRes && histRes.ok) {
      history = await histRes.json();
    }

    render(data, history);
  } catch(e) {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('error-msg').style.display = 'block';
    console.error(e);
  }
}

// ‚îÄ‚îÄ Build rank-history lookup: ticker ‚Üí [rank, rank, rank, ...] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildRankHistory(history) {
  const map = {};
  history.forEach(snapshot => {
    snapshot.stocks.forEach(s => {
      if (!map[s.ticker]) map[s.ticker] = [];
      map[s.ticker].push({ date: snapshot.date, rank: s.rank });
    });
  });
  return map;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(data, history) {
  document.getElementById('loader').style.display = 'none';

  const top20   = data.top20 || [];
  const rankMap = buildRankHistory(history);

  // Header meta
  document.getElementById('updated-time').textContent = 'Updated: ' + data.updated;
  document.getElementById('stocks-screened').textContent =
    data.total_screened + ' of ' + (data.total_attempted || '?') + ' stocks screened';

  // Stat cards
  const newEntries = top20.filter(s => !s.prev_rank).length;
  document.getElementById('stat-screened').textContent    = data.total_screened || '‚Äî';
  document.getElementById('stat-above-rsl').textContent   = top20.filter(s => s.rsl >= 1.0).length + '/20';
  document.getElementById('stat-top-score').textContent   = top20.length ? top20[0].composite.toFixed(1) : '‚Äî';
  document.getElementById('stat-new-entries').textContent = newEntries;
  document.getElementById('stat-weeks').textContent       = history.length;

  // ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const maxScore = Math.max(...top20.map(s => s.composite));
  const minScore = Math.min(...top20.map(s => s.composite));
  const tbody = document.getElementById('main-tbody');
  tbody.innerHTML = '';

  top20.forEach((s, i) => {
    const rank    = i + 1;
    const barPct  = ((s.composite - minScore) / Math.max(maxScore - minScore, 0.001)) * 100;
    const tickerClean = s.ticker.replace('.DE', '').replace('.F', '');

    // Rank change badge
    let prevHTML = '';
    if (!s.prev_rank) {
      prevHTML = '<span class="rank-change rank-new">NEW</span>';
    } else {
      const diff = s.prev_rank - rank;
      if (diff > 0)      prevHTML = `<span class="rank-change rank-up">‚ñ≤${diff} #${s.prev_rank}</span>`;
      else if (diff < 0) prevHTML = `<span class="rank-change rank-down">‚ñº${Math.abs(diff)} #${s.prev_rank}</span>`;
      else               prevHTML = `<span class="rank-change rank-same">‚Äî #${s.prev_rank}</span>`;
    }

    // Mini sparkline (last 8 weeks)
    const hist8 = (rankMap[s.ticker] || []).slice(-8).map(x => x.rank);
    const canvasId = 'spark-' + i;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="rank-num">${String(rank).padStart(2,'0')}</span></td>
      <td>
        <span class="ticker-main">${esc(tickerClean)}</span>
        <span class="company-name">${esc(s.name)}</span>
      </td>
      <td class="center">${indexBadge(s.ticker)}</td>
      <td class="right">
        <div class="score-wrap">
          <span class="score-val">${s.composite.toFixed(1)}</span>
          <div class="score-bar-bg"><div class="score-bar-fill" style="width:${barPct.toFixed(1)}%"></div></div>
        </div>
      </td>
      <td class="right"><span class="${momClass(s.mom_12m)}">${fmtPct(s.mom_12m)}</span></td>
      <td class="right"><span class="${momClass(s.mom_6m)}">${fmtPct(s.mom_6m)}</span></td>
      <td class="right"><span class="${momClass(s.mom_3m)}">${fmtPct(s.mom_3m)}</span></td>
      <td class="right"><span class="${s.rsl >= 1.15 ? 'rsl-ok' : 'rsl-mid'}">${s.rsl.toFixed(3)}</span></td>
      <td class="right">${fmtEur(s.price)}</td>
      <td class="center">${prevHTML}</td>
      <td class="center"><canvas id="${canvasId}" class="sparkline" width="60" height="20" style="width:60px;height:20px"></canvas></td>
    `;
    tbody.appendChild(tr);

    // Draw mini sparkline after DOM insertion
    requestAnimationFrame(() => {
      const c = document.getElementById(canvasId);
      if (c) drawMiniSparkline(c, hist8);
    });
  });

  document.getElementById('main-table').style.display = 'table';

  // ‚îÄ‚îÄ HISTORY CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (history.length >= 2) {
    document.getElementById('history-section').style.display = 'block';
    document.getElementById('history-sub').textContent =
      `Rank trajectory over the last ${history.length} week${history.length !== 1 ? 's' : ''} ` +
      `for each current Top 20 stock. Rank 1 = top of chart.`;

    const grid = document.getElementById('history-grid');
    grid.innerHTML = '';

    top20.forEach(s => {
      const tickerClean = s.ticker.replace('.DE','').replace('.F','');
      const hData = rankMap[s.ticker] || [];
      const ranks = hData.map(x => x.rank);
      const weeksIn = hData.length;

      // Best rank ever
      const bestRank = ranks.length ? Math.min(...ranks) : s.rank;

      const card = document.createElement('div');
      card.className = 'history-card';
      const canvasId = 'hchart-' + tickerClean.replace(/[^a-z0-9]/gi, '_');
      card.innerHTML = `
        <div class="hcard-ticker">${esc(tickerClean)}</div>
        <div class="hcard-name">${esc(s.name)}</div>
        <canvas id="${canvasId}" class="hcard-chart" style="width:100%;height:52px"></canvas>
        <div class="hcard-meta">
          <span>Current rank: <strong style="color:var(--white)">#${s.rank}</strong></span>
          <span class="hcard-weeks">${weeksIn} week${weeksIn !== 1 ? 's' : ''} in top 20</span>
        </div>
        <div style="margin-top:4px; font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted)">
          Best rank ever: <strong style="color:var(--accent)">#${bestRank}</strong>
        </div>
      `;
      grid.appendChild(card);

      requestAnimationFrame(() => {
        const c = document.getElementById(canvasId);
        if (c) {
          c.style.width = '100%';
          c.style.height = '52px';
          setTimeout(() => drawSparkline(c, ranks, 20), 50);
        }
      });
    });
  } else {
    document.getElementById('history-section').style.display = 'block';
    document.getElementById('history-sub').textContent =
      'History builds automatically each Friday. Charts will appear after the second run.';
    document.getElementById('history-grid').innerHTML =
      `<div class="no-history">
        üìä No history yet ‚Äî history accumulates automatically each Friday.<br>
        After a few weeks, rank trajectory charts will appear here for each Top 20 stock.
       </div>`;
  }
}

loadAll();
</script>
</body>
</html>
